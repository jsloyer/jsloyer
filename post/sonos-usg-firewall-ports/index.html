<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Setup a multi-vlan network with sonos and the Unifi USG with Sonos Speakers"><title>Firewall Ports for the Unifi USG and Sonos Speakers</title><link rel=canonical href=https://www.jeffsloyer.io/post/sonos-usg-firewall-ports/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Firewall Ports for the Unifi USG and Sonos Speakers"><meta property='og:description' content="Setup a multi-vlan network with sonos and the Unifi USG with Sonos Speakers"><meta property='og:url' content='https://www.jeffsloyer.io/post/sonos-usg-firewall-ports/'><meta property='og:site_name' content='Jeff Sloyer'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='sonos'><meta property='article:tag' content='usg'><meta property='article:tag' content='firewall'><meta property='article:tag' content='unifi'><meta property='article:tag' content='ubiquiti'><meta property='article:published_time' content='2019-02-11T13:24:00-05:00'><meta property='article:modified_time' content='2019-02-11T13:24:00-05:00'><meta property='og:image' content='https://www.jeffsloyer.io/post/sonos-usg-firewall-ports/wall.jpg'><meta name=twitter:title content="Firewall Ports for the Unifi USG and Sonos Speakers"><meta name=twitter:description content="Setup a multi-vlan network with sonos and the Unifi USG with Sonos Speakers"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.jeffsloyer.io/post/sonos-usg-firewall-ports/wall.jpg'><link rel="shortcut icon" href=/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=G-1SGYYQEYE5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1SGYYQEYE5")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/airplane_hu_b02b01ef7f6fbee8.png width=300 height=225 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jeff Sloyer</a></h1><h2 class=site-description>Thoughts on Tech and other interests...</h2></div></header><ol class=menu-social><li><a href=https://github.com/jsloyer target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/jeffsloyer/ target=_blank title="Linked In" rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li><li><a href=https://twitter.com/jsloyer target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/speaking/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>Speaking</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#block-all-untrusted-traffic>Block all untrusted traffic</a></li><li><a href=#allow-icmp-traffic>Allow ICMP Traffic</a></li><li><a href=#allow-sonos-traffic>Allow Sonos Traffic</a><ol><li><a href=#allow-sonos-tcp>Allow Sonos TCP</a></li><li><a href=#allow-sonos-udp>Allow Sonos UDP</a></li></ol></li><li><a href=#ordering-of-the-rules>Ordering of the rules</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/sonos-usg-firewall-ports/><img src=/post/sonos-usg-firewall-ports/wall_hu_b945bd4d121e32b5.jpg srcset="/post/sonos-usg-firewall-ports/wall_hu_b945bd4d121e32b5.jpg 800w, /post/sonos-usg-firewall-ports/wall_hu_b82431f2004accd7.jpg 1600w" width=800 height=532 loading=lazy alt="Featured image of post Firewall Ports for the Unifi USG and Sonos Speakers"></a></div><div class=article-details><header class=article-category><a href=/categories/tutorial/>Tutorial</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/sonos-usg-firewall-ports/>Firewall Ports for the Unifi USG and Sonos Speakers</a></h2><h3 class=article-subtitle>Setup a multi-vlan network with sonos and the Unifi USG with Sonos Speakers</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 11, 2019</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h1 id=background>Background</h1><p>At home I run the 4 port USG router on my Unifi&rsquo;ed network. I have a couple different VLAN&rsquo;s, Data, Management, Security, IoT, and Guest.
Each of these networks already has some policies that prevent some of the VLAN&rsquo;s talking to each other. For example I have some firewall rules that prevent my security cameras from talking to the IoT network and talking out to the public Internet. For the past couple months I haven&rsquo;t been running a locked down IoT network. What this means for me is not allowing the IoT VLAN to talk to my Data and Management VLAN&rsquo;s. This is a problem as all of my servers, my iPhone, and laptop are on the Data VLAN. When I turned on a firewall rule to block all traffic to the Data VLAN from the IoT VLAN my Sonos speakers stopped working. After lots of research and trial and error I got things working again. To get things working again you need to run a ICMP Proxy on your USG as well as turn on some additional firewall rules.</p><h1 id=icmp-proxy>ICMP Proxy</h1><p>The ICMP Proxy is probably the most important bit of all of this. The proxy will forward ICMP packets from one VLAN to another. This is crucial in getting Sonos to work on a multi-VLAN setup. For me the following configuration worked, I will walk through what needs to be changed for your setup.</p><p><strong>Notes</strong></p><ul><li>VLAN 2 is my Data VLAN (trusted)</li><li>VLAN 4 is my IoT VLAN (untrusted)</li><li>The config below is for a USG 4 Port. If you are running a 3 Port USG change <code>eth0</code> to <code>eth1</code>.</li><li>You will need to change the VLAN numbers twice below, for example <code>eth0.2</code> and <code>eth0.4</code>.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    &#34;protocols&#34;: {
</span></span><span class=line><span class=cl>        &#34;igmp-proxy&#34;: {
</span></span><span class=line><span class=cl>            &#34;interface&#34;: {
</span></span><span class=line><span class=cl>                &#34;eth0.2&#34;: {
</span></span><span class=line><span class=cl>                    &#34;alt-subnet&#34;: [
</span></span><span class=line><span class=cl>                        &#34;0.0.0.0/0&#34;
</span></span><span class=line><span class=cl>                    ],
</span></span><span class=line><span class=cl>                    &#34;role&#34;: &#34;upstream&#34;,
</span></span><span class=line><span class=cl>                    &#34;threshold&#34;: &#34;1&#34;
</span></span><span class=line><span class=cl>                },
</span></span><span class=line><span class=cl>                &#34;eth0.4&#34;: {
</span></span><span class=line><span class=cl>                    &#34;alt-subnet&#34;: [
</span></span><span class=line><span class=cl>                        &#34;0.0.0.0/0&#34;
</span></span><span class=line><span class=cl>                    ],
</span></span><span class=line><span class=cl>                    &#34;role&#34;: &#34;downstream&#34;,
</span></span><span class=line><span class=cl>                    &#34;threshold&#34;: &#34;1&#34;
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>The above snippet will need to go on your Unifi Controller. If you are on Linux it is located at <code>/var/lib/unifi/sites&lt;siteid>/config.gateway.json</code>. To get your site id open your web browser and log into your Unifi controller. The site id will be in the url. Make sure you are targheted to the correct site. For example a possible url could be <code>https://10.1.1.1:8443/manage/site/fozvabde/devices/1/50</code>. In this case the site id is <code>fozvabde</code>.</p><p>Once you have placed your eddited JSON snippet into <code>/var/lib/unifi/sites&lt;siteid>/config.gateway.json</code> login into your controller and navigate to the Devices tab. On that tab select the USG and then click on Config and then Manage Device. Here you will want to click on force provision. Doing this will write the above <code>config.gateway.json</code> file to your USG and then turn on the ICMP Proxy. At this point check to make sure having a Sonos controller on your trusted VLAN can talk to your Sonos Speakers on your untrusted VLAN. If it doesn&rsquo;t work check the <code>config.gateway.json</code> file and make sure you have your interfaces and VLAN&rsquo;s correct. If you can&rsquo;t figure it out leave a comment below.</p><h1 id=firewall-rules>Firewall Rules</h1><p>Since we now have things working again we need to break things again. We need to block the traffic from the untrusted VLAN to the trusted VLAN.</p><h2 id=block-all-untrusted-traffic>Block all untrusted traffic</h2><p><a class=link href=usg-sonos-1.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-1.jpg width=1424 height=1628 srcset="/post/sonos-usg-firewall-ports/usg-sonos-1_hu_5a3e5c3ccdc82f81.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-1_hu_a342360c5b767b79.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=87 data-flex-basis=209px></a></p><p><a class=link href=usg-sonos-2.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-2.jpg width=1146 height=428 srcset="/post/sonos-usg-firewall-ports/usg-sonos-2_hu_faf2aef95b46338a.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-2_hu_d8826396c12708f2.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=267 data-flex-basis=642px></a></p><p>I have a group created for my untrusted VLAN&rsquo;s, see below.</p><p><a class=link href=usg-sonos-3.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-3.jpg width=1686 height=858 srcset="/post/sonos-usg-firewall-ports/usg-sonos-3_hu_be2cb18a7ed99000.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-3_hu_6050d0a608c303b.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=196 data-flex-basis=471px></a></p><h2 id=allow-icmp-traffic>Allow ICMP Traffic</h2><p>Next we need to allow ICMP traffic from your untrusted VLAN to your trusted VLAN. See below.
<a class=link href=usg-sonos-4.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-4.jpg width=1472 height=1608 srcset="/post/sonos-usg-firewall-ports/usg-sonos-4_hu_18600f8fe84dc53f.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-4_hu_2c72de1778fc1fa0.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=91 data-flex-basis=219px></a></p><p><a class=link href=usg-sonos-5.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-5.jpg width=1156 height=406 srcset="/post/sonos-usg-firewall-ports/usg-sonos-5_hu_9e80e77f01cd232e.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-5_hu_48904c58e6c56a7e.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=284 data-flex-basis=683px></a></p><h2 id=allow-sonos-traffic>Allow Sonos Traffic</h2><p>Next wee need to allow Sonos traffic. To do this I created two port groups, one for UDP and one for TCP. each of them has a corresponding firewall rule.</p><h3 id=allow-sonos-tcp>Allow Sonos TCP</h3><p>I created a port group for my TCP traffic. See below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SRC SONOS - DST STREAM-DEVICE - TCP
</span></span><span class=line><span class=cl>TCP-3401
</span></span><span class=line><span class=cl>TCP30000-60000
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=usg-sonos-6.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-6.jpg width=1948 height=914 srcset="/post/sonos-usg-firewall-ports/usg-sonos-6_hu_836def85220756f3.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-6_hu_ea739eb71f3e40da.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=213 data-flex-basis=511px></a></p><p>In the rule below you will notice there is a destination group as well in addition to the ports. I have added the IP&rsquo;s of my Sonos speakers to a group so I can only open a couple pinholes for traffic instead of the whole VLAN. See below.</p><p><a class=link href=usg-sonos-8.png><img src=/post/sonos-usg-firewall-ports/usg-sonos-8.png width=2112 height=1188 srcset="/post/sonos-usg-firewall-ports/usg-sonos-8_hu_4bd3aa9121cb70ed.png 480w, /post/sonos-usg-firewall-ports/usg-sonos-8_hu_d918f13cac0b94ff.png 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=177 data-flex-basis=426px></a></p><p><a class=link href=usg-sonos-9.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-9.jpg width=1446 height=1636 srcset="/post/sonos-usg-firewall-ports/usg-sonos-9_hu_37cb79e16912b75a.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-9_hu_bba1008c51c1d013.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=88 data-flex-basis=212px></a></p><p><a class=link href=usg-sonos-10.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-10.jpg width=1266 height=342 srcset="/post/sonos-usg-firewall-ports/usg-sonos-10_hu_6a218a90cbc208de.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-10_hu_3ad817f738e46341.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=370 data-flex-basis=888px></a></p><h3 id=allow-sonos-udp>Allow Sonos UDP</h3><p>I created a port group for my TCP traffic. See below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SRC SONOS - DST STREAM-DEVICE - UDP
</span></span><span class=line><span class=cl>UDP-1901
</span></span><span class=line><span class=cl>UDP30000-60000
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=usg-sonos-7.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-7.jpg width=1930 height=830 srcset="/post/sonos-usg-firewall-ports/usg-sonos-7_hu_1636874e2f52e4c9.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-7_hu_d5ac6181bc1f11fa.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=232 data-flex-basis=558px></a></p><p>I am using the same port group for the source as I did above for the IP&rsquo;s of the Sonos speakers.</p><p><a class=link href=usg-sonos-11.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-11.jpg width=1550 height=1642 srcset="/post/sonos-usg-firewall-ports/usg-sonos-11_hu_6afd124fc9f2c478.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-11_hu_8a364c7e9481c6d0.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=94 data-flex-basis=226px></a></p><p><a class=link href=usg-sonos-12.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-12.jpg width=1218 height=430 srcset="/post/sonos-usg-firewall-ports/usg-sonos-12_hu_3df22e91c91c8e1d.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-12_hu_a6ff07484c78391a.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=283 data-flex-basis=679px></a></p><h2 id=ordering-of-the-rules>Ordering of the rules</h2><p>The ordering of the firewall rules is extremely important. Make sure you have your allow rules before your deny rules. If not things will not work.</p><p>See below for my final set of rules.</p><p><a class=link href=usg-sonos-13.jpg><img src=/post/sonos-usg-firewall-ports/usg-sonos-13.jpg width=2376 height=1526 srcset="/post/sonos-usg-firewall-ports/usg-sonos-13_hu_8cabc6ce3d712f30.jpg 480w, /post/sonos-usg-firewall-ports/usg-sonos-13_hu_52bf43486d0cc38e.jpg 1024w" loading=lazy alt="usg screenshot from unifi" class=gallery-image data-flex-grow=155 data-flex-basis=373px></a></p><h1 id=credit>Credit</h1><p><a class=link href=https://en.community.sonos.com/troubleshooting-228999/multiple-subnets-vlans-and-sonos-workable-clavister-solution-30950 target=_blank rel=noopener>https://en.community.sonos.com/troubleshooting-228999/multiple-subnets-vlans-and-sonos-workable-clavister-solution-30950</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/sonos/>Sonos</a>
<a href=/tags/usg/>Usg</a>
<a href=/tags/firewall/>Firewall</a>
<a href=/tags/unifi/>Unifi</a>
<a href=/tags/ubiquiti/>Ubiquiti</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/post/apple-airplay-usg/><div class=article-image><img src=/post/apple-airplay-usg/wall.295b9d2986181b5d5c420b59d68d8d0d_hu_d2bc04d983717b1e.jpg width=250 height=150 loading=lazy alt="Featured image of post Cross VLAN traffic with a USG and Apple Airplay" data-key=/apple-airplay-usg data-hash="md5-KVudKYYYG11cQgtZ1o2NDQ=="></div><div class=article-details><h2 class=article-title>Cross VLAN traffic with a USG and Apple Airplay</h2></div></a></article><article class=has-image><a href=/post/apple-airplay-udm/><div class=article-image><img src=/post/apple-airplay-udm/sound_mixer.bfb8adfedcf1aa17fe9d0fe784396332_hu_d6e50af852bef0f6.jpg width=250 height=150 loading=lazy alt="Featured image of post Cross VLAN traffic with a UDM/UDM-Pro and Apple Airplay" data-key=apple-airplay-udm/ data-hash="md5-v7it/tzxqhf+nQ/nhDljMg=="></div><div class=article-details><h2 class=article-title>Cross VLAN traffic with a UDM/UDM-Pro and Apple Airplay</h2></div></a></article><article class=has-image><a href=/post/att-uverse-modem-bypass-unifi-usg/><div class=article-image><img src=/post/att-uverse-modem-bypass-unifi-usg/secure.606435b51e769ee2fe6081b719a56342_hu_f7692aead6e56c4e.jpg width=250 height=150 loading=lazy alt="Featured image of post ATT Uverse Modem Bypass - UniFi USG" data-key=att-uverse-modem-bypass-unifi-usg/ data-hash="md5-YGQ1tR52nuL+YIG3GaVjQg=="></div><div class=article-details><h2 class=article-title>ATT Uverse Modem Bypass - UniFi USG</h2></div></a></article><article class=has-image><a href=/post/ibm-container-service-cabin/><div class=article-image><img src=/post/ibm-container-service-cabin/cabin.f03eadbb8fefde41e02513c1a4720b02_hu_4957279fd000ac7f.jpg width=250 height=150 loading=lazy alt="Featured image of post Using Cabin with the IBM Bluemix Container Service" data-key=ibm-container-service-cabin/ data-hash="md5-8D6tu4/v3kHgJRPBpHILAg=="></div><div class=article-details><h2 class=article-title>Using Cabin with the IBM Bluemix Container Service</h2></div></a></article><article class=has-image><a href=/post/peering-inside-a-criminals-mind-using-ibm-watson/><div class=article-image><img src=/post/peering-inside-a-criminals-mind-using-ibm-watson/glasses.27d239de06198fae9a949f59a6820f1c_hu_6136c73f1583bc6d.jpg width=250 height=150 loading=lazy alt="Featured image of post Peering Inside a Criminal‚Äôs Mind using IBM Watson" data-key=peering-inside-a-criminals-mind-using-ibm-watson/ data-hash="md5-J9I53gYZj66alJ9ZpoIPHA=="></div><div class=article-details><h2 class=article-title>Peering Inside a Criminal‚Äôs Mind using IBM Watson</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//jeffsloyerio.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Jeff Sloyer</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>